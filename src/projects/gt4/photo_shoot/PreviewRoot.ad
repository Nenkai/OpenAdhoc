module PhotoShootProject::PreviewRoot
{
	#include "../share/imageControl.ad"
	static desc_str = "description";

	function onInitialize(context)
	{
		context.cursor_visible = false;
	
		ToolTip::tip.lock.value = 0;
		ToolTip::tip.key = desc_str;
		ToolTip::tip.lock.value = 1;
	
		attachImageControl(context);
	}

	function onFinalize(context)
	{
		removeImageControl(context);
		context.cursor_visible = true;
	}

	function onCancel(context, event, item)
	{
		main::sound.play("cancel");
		context.transition.panOut(context);
		context.transition.syncOut(context);
		context.startPage(ShootRoot);
		return EVENTRESULT_FILTER;
	}

	function onKeyPress(context, event)
	{
		if (event.keysym == 65421 && !PR.isRendering(context))
		{
			removeImageControl(context);
			context.cursor_visible = true;
	
			if (SaveDialog::open(context, 1))
			{
				ToolTip.visible = false;
	
				var slot = SaveDialog::slot;
				var kind = SaveDialog::kind;
	
				if (slot == 2)
				{
					outUSB(context);
				}
				else
				{
					var r = true;
	
					if (kind == 0 || kind == 1)
					{
						r = saveVariousData(context, "MODE_SAVE_PHOTO_FILM", "film", slot);
					}
	
					if (r && (kind == 1 || kind == 2))
					{
						saveVariousData(context, "MODE_SAVE_PHOTO_PICTURE", "photo", slot);
					}
				}
	
				ToolTip.visible = true;
			}
	
			context.cursor_visible = false;
			attachImageControl(context);
			return EVENTRESULT_FILTER;
		}
	
		checkUnformat(context, event);
		return false;
	}

	function outUSB(context)
	{
		print("out USB Storage");
	
		if (openConfirmDialog(context, 1, context.translate(PreviewRoot, "out usb memory ok?")))
		{
			var progress = main::menu::MProgress();
			setProgress(context, progress);
			progress.value = 0.0;
			progress.value = 0.3;
			openProgressDialog(context, context.translate(PreviewRoot, "now saving"));
	
			var r = PR.outUSBStorage(context);
			if (r == "OK")
			{
				progress.value = 1.0;
				progress.value = 1.0;
				context.sync(0.3);
			}
			
			closeProgressDialog(context);
			openConfirmDialog(context, (r == "OK" ? 0 : 2), context.translate(PreviewRoot, "usbresult|" + r));
		}
		print("end USB Storage");
	}
}