module ROOT
{
    attribute popup;
    attribute closed = false;
    attribute greeting;

    method open(context, greeting)
    {
        self.greeting = greeting;
        self.closed = false;

        self.popup = main::SequenceUtil::ModalPage(context, ROOT);
        self.popup.open();

        return true;
    }

    method close(context)
    {
        if (self.closed)
            return;

        self.closed = true;
        ContextMain.event_mask = 0x05;
        ContextMain.disableInput();

        FadeActor.on_effect_end = function (context)
        {
            if (ROOT.popup != nil)
            {
                ROOT.popup.close();
                ROOT.popup = nil;
            }

            ContextMain.enableInput();
        }

        FadeActor.out = true;
    }

    method onInitialize(context)
    {
        ButtonHelpGT5.set(context, 
        [
            [ButtonHelpGT5.getCancelButtonName(), context.translate(ROOT, "MyHome", "BUTTON_HELP_CLOSE")]
        ]);

        Pane::TextFace.text = context.translate(ROOT, "YOU_GOT_GREETING_CARD").build(pdistd::getPlayerName());

        var image_id = self.greeting["image_id"];
        var request = Grim2.requestGreetingImage(image_id, function (args) {});
        if (Grim2Util::__deprecated__join__(context, request))
            Pane::Image::ImageFace.image_path = Grim2.getGreetingImagePath(image_id);

        main::sound.play("attention");

        ROOT.setFocus(ROOT);
        context.cursor_visible = false;

        return EVENTRESULT_FILTER;
    }

    method onFinalize(context)
    {
        SoundUtil::MenuBGMCrossfadeGroup("menu", 0.0, 3.0, true);
        Pane::Image::ImageFace.image_path = "";

        context.cursor_visible = true;
    }

    method onCancel(context)
    {
        main::sound.play("cancel");
        close(context);

        return EVENTRESULT_FILTER;
    }
}