module PROJECT::ROOT
{
    function onLoad()
    {
        setFadeActor(Username::bgf);
        setFadeActor(Password::bgf);
        setFadeActor(Login::bgf);
        setFadeActor(New::bgf);
    }

    function onInitialize(context)
    {
        Username::Input::input.value = main::game.username;
        Password::Input::input.value = main::game.password;

        if (main::game.username == "")
            ROOT.setFocus(Username::Input::input);
        else if (main::game.password == "")
            ROOT.setFocus(Password::Input::input);
        else
            ROOT.setFocus(Login);
    }

    function onCancel(context)
    {
        var result = openConfirmDialog(context, 1, context.translate(ConnectRoot, "QUIT"));
        if (result)
            start_page(context, ServerRoot);
		
        return EVENTRESULT_FILTER;
    }
}

module PROJECT::ROOT::Login
{
    function login(context, args)
    {
        main::network.beginEnableAbort();

        var next_page = PolicyRoot;

        var res = main::network.login(main::game.username, main::game.password);
        if (!res)
        {
            var error_code = main::network.getLastErrorCode();
            openConfirmDialog(context, 0, error_code);
            next_page = ROOT;
        }
        else
        {
            var r = svo::Login(main::network.my_id.toString(), main::network.my_name, main::game.password);

            gHttp.close();
            main::network.setSvoCookie(gHttp.GetMHttp());
        }

        main::network.endEnableAbort();
        start_page(context, next_page);
    }

    function onActivate(context)
    {
        main::sound.play("ok");

        var username = Username::Input::input.value;
        if (username == "")
        {
            openConfirmDialog(context, 0, context.translate(ROOT, "NO_NAME"));
            return EVENTRESULT_FILTER;
        }

        var password = Password::Input::input.value;
        if (password == "")
        {
            openConfirmDialog(context, 0, context.translate(ROOT, "NO_PASSWORD"));
            return EVENTRESULT_FILTER;
        }

        main::game.username = username;
        main::game.password = password;

        openProcessDialog(
            context,
            context.translate(ROOT, "WAIT_FOR_LOGIN"),
            login,
            nil
        );

        return EVENTRESULT_FILTER;
    }
}

module PROJECT::ROOT::New
{
    function onActivate(context)
    {
        main::sound.play("ok");
        start_page(context, RegisterRoot);
        return EVENTRESULT_FILTER;
    }
}