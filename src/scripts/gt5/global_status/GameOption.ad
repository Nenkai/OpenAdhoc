

//---------------------------------------------------------------------------------------
// GameOption.ad
//
// Creates the save profile config entity
// 
//---------------------------------------------------------------------------------------


//---------------------------------------------------------------------------------------
// module
//---------------------------------------------------------------------------------------
module GameOption
{
    function clearInitializer()
    {
        undef CreateStructure;
        undef Initialize;
        undef DefineMethod;
        undef DeclareControllers;
        undef clearInitializer;
    }

    function CreateStructure()
    {
        var st = STStructure("Impl");
        GameOption.defineModule(st);

        st.define("extra_language", STByte());
        st.define("extra_language_done", STByte());

        // Units
        st.define("unit_velocity", STByte());
        st.define("unit_power", STByte());
        st.define("unit_torque", STByte());
        st.define("unit_temperature", STByte());

        st.define("timeout_count_to_topmenu", STInt());


        st.define("special_arcade_tuner", STInt());
        st.define("arcade_skip_to_favorite", STByte());
        st.define("opening_after_autoload", STByte());
        st.define("save_full_replay", STByte());
        st.define("demo_movie_interval", STByte());
        st.define("demo_returning_to_menu_interval", STByte());
        st.define("menu_inactive_pad_mode", STByte());
        st.define("demo_ranker_replay_mode", STByte());
        st.define("auto_demo_mode", STByte());
        st.define("auto_save", STByte());
        st.define("autodemo_start_interval", STInt());
        st.define("autodemo_time_limit", STInt());
        st.define("autodemo_time_limit_max", STInt());
        st.define("boot_signin", STByte());
        st.define("open_special_option", STByte());
        st.define("open_config_stereogram", STByte());

        // Kiosk params
        st.define("kiosk_mode", STByte());
        st.define("limit_tuner", STString(32));
        st.define("limit_favorite_course_only", STByte());
        st.define("limit_favorite_car_only", STByte());
        st.define("limit_enemies_to_favorite_car_only", STByte());
        st.define("limit_demo_to_favorite_car_only", STByte());
        st.define("favorite_cars", STArray(STULong(), 80));
        st.define("favorite_enemies", STArray(STULong(), 80));
        st.define("favorite_courses", STArray(STULong(), 20));
        st.define("favorite_demo_cars", STArray(STULong(), 80));
        st.define("favorite_enemies_pp_range", STInt());

        // Arcade user settings
        st.define("arcade_laps", STInt());
        st.define("arcade_tire_damage", STByte());
        st.define("arcade_time_limit", STInt());
        st.define("arcade_entry_limit", STByte());
        st.define("arcade_ai_roughness", STInt());
        st.define("arcade_enable_damage", STByte());
        st.define("arcade_timetrial_laps", STInt());

        st.define("professional_control_1p", STByte());
        st.define("professional_control_2p", STByte());
        st.define("special_driver_model_1p", STByte());
        st.define("special_driver_model_2p", STByte());
        st.define("special_guest", STByte());
        st.define("special_guest_name", STString(64));
        st.define("special_guest_region", STString(10));
        st.define("penalty_type", STByte());
        st.define("strict_judgment", STByte());
        st.define("display_license_bestline", STByte());
        st.define("race_display_layout", STByte());
        st.define("play_view_1p", STByte());
        st.define("play_view_2p", STByte());
        st.define("replay_mode", STByte());
        st.define("full_quality_replay", STByte());

        st.define("race_map_scale", STShort());
        st.define("race_map_fixed_north_up", STByte());
        st.define("race_map_view_mode", STByte());

        st.define("racedisplay_view_mode", STByte());

        // Display modes
        st.define("carmeter_disp_mode", STByte());
        st.define("suggested_disp_mode", STByte());
        st.define("tireload_disp_mode", STByte());
        st.define("times_disp_mode", STByte());
        st.define("racername_disp_mode", STByte());
        st.define("current_disp_mode", STByte());

        st.define("racer_list_car", STByte());

        st.define("edit_course_data_id", STLong());


        // Input configs
        st.define("vibration_1p", STByte());
        st.define("vibration_2p", STByte());
        st.define("key_config", STObject(gtengine::MController));
        st.define("default_sixaxis", STObject(System::Map));
        st.define("default_leopard", STObject(System::Map));
        st.define("default_tigar", STObject(System::Map));
        st.define("default_cheetah", STObject(System::Map));
        st.define("default_cougar", STObject(System::Map));
        st.define("default_jaguar", STObject(System::Map));
        st.define("default_trs", STObject(System::Map));
        st.define("default_panther", STObject(System::Map));
        st.define("default_uncia", STObject(System::Map));

        // Assists
        st.define("active_steering_1p", STByte());
        st.define("active_steering_2p", STByte());
        st.define("steering_assist_type_1p", STByte());
        st.define("steering_assist_type_2p", STByte());
        st.define("FFB_assist_1p", STByte());
        st.define("FFB_assist_2p", STByte());
        st.define("FFB_level_1p", STByte());
        st.define("FFB_level_2p", STByte());

        // Volumes
        st.define("menu_bgm_volume", STShort());
        st.define("menu_se_volume", STShort());
        st.define("race_bgm_volume", STShort());
        st.define("race_se_volume", STShort());
        st.define("replay_bgm_volume", STShort());
        st.define("replay_se_volume", STShort());
        st.define("user_bgm_volume", STShort());
        st.define("slide_bgm_volume", STShort());
        st.define("menu_bgm", STByte());
        st.define("menu_se", STByte());
        st.define("race_bgm", STByte());
        st.define("race_se", STByte());
        st.define("replay_bgm", STByte());
        st.define("replay_se", STByte());
        st.define("bgm_upmix_enable", STByte());
        st.define("speaker_layout", STByte());
        st.define("speaker_bits", STShort());
        st.define("speaker_angles", STArray(STShort(), 8));
        st.define("sound_dynamic_range", STByte());
        st.define("loudness_correct", STByte());
        st.define("sysbgm_use", STArray(STByte(), 8));
        st.define("sysbgm_valid", STArray(STByte(), 8));
        st.define("sysbgm_context", STArray(STArray(STByte(), main::pdiext::MSystemBGM::getContextSize()), 8));
        
        // Screen settings
        st.define("screen_brightness", STByte());
        st.define("screen_sharpness", STByte());
        st.define("display_margin_sd", STByte());
        st.define("display_margin_sd_adjust_done", STByte());
        st.define("display_margin_hd", STByte());
        st.define("display_margin_hd_adjust_done", STByte());

        // Misc
        st.define("gt_hifi", STByte());
        st.define("temporal_aa", STByte());
        st.define("extra_wide", STByte());
        st.define("image_quality", STByte());

        st.define("photo_avatar_visible", STByte());

        // Slideshow settings
        st.define("slideshow_style", STByte());
        st.define("slideshow_interval", STFloat());
        st.define("slideshow_transition", STFloat());
        st.define("slideshow_imagetype", STByte());
        st.define("slideshow_bgm", STByte());
        st.define("slideshow_repeat", STByte());
        st.define("slideshow_shuffle", STByte());

        st.define("stop_install", STByte());

        // Server settings
        st.define("server_special_value", STString(64));
        st.define("asset_download_on_boot", STByte());
        st.define("fixed_private_room", STString(16));
        st.define("is_academy_final", STByte());
        st.define("academy_final_event_id", STInt());
        st.define("academy_final_is_host", STByte());
        st.define("academy_final_is_entry", STByte());
        st.define("academy_final_course_code", STLong());
        st.define("academy_final_car_code", STLong());
        st.define("academy_final_car_color", STByte());
        st.define("academy_final_car_grid", STByte());
        st.define("bot_on", STByte());
        st.define("bot_host", STByte());
        st.define("bot_name", STString(32));
        st.define("bot_type", STByte());
        st.define("bot_group", STString(32));
        st.define("bot_room", STString(32));
        st.define("bot_course", STLong());
        st.define("force_nickname", STString(32));
        st.define("bandwidth_up", STArray(STLong(), 3));
        st.define("bandwidth_down", STArray(STLong(), 3));
        st.define("lounge_demo", STByte());
        st.define("lounge_change_view", STByte());
        st.define("lounge_chat_disabled", STByte());
        st.define("lounge_keyboard_switcher", STByte());
        st.define("lounge_split_screen", STByte());
        st.define("lounge_auto_replay_save", STByte());

        st.define("open_match_course", STLong());
        st.define("open_match_comment", STString(64));
        st.define("open_match_only_garage_car", STByte());
        st.define("open_match_room_max", STByte());
        st.define("open_match_racer_max", STByte());
        st.define("open_match_voice_chat", STByte());
        st.define("open_match_voice_quality", STByte());
        st.define("open_match_trackday_mode", STByte());
        st.define("open_match_auto_grant_ownership", STByte());
        st.define("open_match_room_policy", STByte());

        // Pace/DLS (GTTV)
        st.define("pace_force_open_agreement", STByte());
        st.define("pace_on", STByte());
        st.define("pace_upload_rate_max_bps", STInt());
        st.define("pace_download_rate_max_bps", STInt());
        st.define("pace_download_from_server_only", STByte());
        st.define("pace_debug", STByte());

        // Multimonitor
        st.define("monitor_host", STByte());
        st.define("monitor_client", STByte());
        st.define("monitor_host_ip", STString(16));
        st.define("monitor_follow_host", STByte());
        st.define("monitor_preset", STByte());
        st.define("monitor_layout", STByte());
        st.define("monitor_layout_x", STByte());
        st.define("monitor_layout_y", STByte());
        st.define("monitor_index", STByte());
        st.define("monitor_round_xy", STByte());
        st.define("monitor_round_angle", STFloat());
        st.define("monitor_view_angle_xy", STByte());
        st.define("monitor_view_angle", STFloat());
        st.define("monitor_view_angle_scale", STFloat());
        st.define("monitor_aspect_ratio_x", STInt());
        st.define("monitor_aspect_ratio_y", STInt());
        st.define("monitor_aspect_ratio_enable", STByte());
        st.define("monitor_rotate", STArray(STFloat(), 3));
        st.define("monitor_translate", STArray(STFloat(), 3));
        st.define("monitor_height", STFloat());
        st.define("monitor_view_offset_x", STFloat());
        st.define("monitor_convergence", STFloat());
        st.define("monitor_frame_delay", STFloat());
        st.define("monitor_frame_delay_enable", STByte());
        st.define("monitor_border", STArray(STFloat(), 2));
        st.define("monitor_pixel_jitter_enable", STByte());
        st.define("monitor_flip_timing", STFloat());
        st.define("monitor_flip_timing_enable", STByte());
        st.define("monitor_race_display_enable", STByte());
        st.define("monitor_race_display_mode", STByte());
        st.define("monitor_use_parallax_view", STByte());
        st.define("monitor_parallax_change_mode", STInt());
        st.define("monitor_ui_depth", STFloat());
        st.define("monitor_auto_boot", STByte());

        // PS Eye
        st.define("pseye_face_threshold", STFloat());
        st.define("pseye_face_angle", STInt());
        st.define("pseye_face_position", STInt());
        st.define("pseye_max_face_size", STInt());
        st.define("pseye_min_face_size", STInt());
        st.define("pseye_camera_exposure", STFloat());
        st.define("pseye_camera_gain", STFloat());

        // ?
        st.define("simulview_2p_battle", STByte());

        // ?
        st.define("visible_demo_carshow", STByte());
        st.define("visible_demo_opening", STByte());
        st.define("visible_demo_museum", STByte());
        st.define("visible_demo_race", STByte());
        st.define("visible_demo_replay", STByte());
        st.define("visible_icon_arcade", STByte());
        st.define("visible_icon_split", STByte());
        st.define("visible_icon_news", STByte());
        st.define("visible_icon_gttv", STByte());
        st.define("visible_icon_gtmode", STByte());
        st.define("visible_icon_online", STByte());
        st.define("visible_icon_ranking", STByte());
        st.define("visible_icon_event", STByte());
        st.define("visible_icon_dealer", STByte());
        st.define("visible_icon_replay", STByte());
        st.define("visible_icon_option", STByte());
        st.define("visible_icon_manual", STByte());
        st.define("visible_icon_save", STByte());
        st.define("visible_icon_coursemaker", STByte());
        st.define("visible_icon_onemake", STByte());
        st.define("visible_icon_timetrial", STByte());
        st.define("visible_icon_singlerace", STByte());
        st.define("visible_icon_drifttrial", STByte());
        st.define("visible_icon_usercustom", STByte());
        st.define("visible_icon_dlc", STByte());
        st.define("visible_icon_lounge", STByte());

        st.define("no_photo_license", STByte());

        st.define("demo_version_code", STString(16));

        st.define("academy_mode", STByte());

        st.define("rtext_debug", STByte());

        DefineMethod();
        DeclareControllers();

        return st;
    }

    function Initialize(instance)
    {
        instance.extra_language = pdistd::Language::SYSTEM;
        instance.extra_language_done = false;
        instance.unit_velocity = main::pdiext::MUnit::GetCurrentUnitOfVelocity();
        instance.unit_power = main::pdiext::MUnit::GetCurrentUnitOfPower();
        instance.unit_torque = main::pdiext::MUnit::GetCurrentUnitOfTorque();
        instance.unit_temperature = main::pdiext::MUnit::GetCurrentUnitOfTemperature();
        instance.timeout_count_to_topmenu = 0;
        instance.opening_after_autoload = true;
        instance.demo_returning_to_menu_interval = 3;
        instance.autodemo_start_interval = 90;
        instance.autodemo_time_limit = 0;
        instance.autodemo_time_limit_max = 500;
        instance.boot_signin = true;
        instance.open_special_option = false;
        instance.open_config_stereogram = false;
        instance.kiosk_mode = false;
        instance.limit_favorite_course_only = false;
        instance.limit_favorite_car_only = false;
        instance.limit_enemies_to_favorite_car_only = false;
        instance.limit_demo_to_favorite_car_only = false;
        instance.limit_tuner = "";

        for (var i = 0; i < 80; i++)
            instance.favorite_cars[i] = main::gtengine::MSpecDB::NO_CODE64;

        for (var i = 0; i < 80; i++)
            instance.favorite_enemies[i] = main::gtengine::MSpecDB::NO_CODE64;

        for (var i = 0; i < 20; i++)
            instance.favorite_courses[i] = main::gtengine::MSpecDB::NO_CODE64;

        for (var i = 0; i < 80; i++)
            instance.favorite_demo_cars[i] = main::gtengine::MSpecDB::NO_CODE64;

        instance.favorite_enemies_pp_range = 0;
        instance.arcade_laps = 2;
        instance.arcade_tire_damage = 0;
        instance.arcade_time_limit = 0;
        instance.arcade_entry_limit = 0;
        instance.arcade_ai_roughness = 0;
        instance.arcade_enable_damage = 1;
        instance.arcade_timetrial_laps = 0;
        instance.special_driver_model_1p = 0;
        instance.special_driver_model_2p = 0;
        instance.special_guest = false;
        instance.special_guest_name = "";
        instance.special_guest_region = "";
        instance.race_display_layout = main::gtengine::RaceDisplayLayout::NORMAL;
        instance.play_view_1p = main::gtengine::CameraPlayView::NORMAL;
        instance.play_view_2p = main::gtengine::CameraPlayView::NORMAL;
        instance.replay_mode = 0;
        instance.full_quality_replay = 0;
        instance.race_map_scale = 5;
        instance.race_map_fixed_north_up = false;
        instance.race_map_view_mode = 1;
        instance.racedisplay_view_mode = 0;
        instance.carmeter_disp_mode = true;
        instance.suggested_disp_mode = true;
        instance.tireload_disp_mode = false;
        instance.times_disp_mode = true;
        instance.racername_disp_mode = true;
        instance.current_disp_mode = true;
        instance.racer_list_car = false;
        instance.edit_course_data_id = 0;
        instance.vibration_1p = true;
        instance.vibration_2p = true;
        instance.key_config = gtengine::MController();
       
        var default_config = gtengine::MController().getConfig();
        var play_config = default_config[main::gtengine::InputMode::PLAY_NORMAL];
        instance.default_sixaxis = play_config["SIXAXIS"];
        instance.default_leopard = play_config["LEOPARD"];
        instance.default_tigar = play_config["TIGAR"];
        instance.default_jaguar = play_config["JAGUAR"];
        instance.default_cheetah = play_config["CHEETAH"];
        instance.default_cougar = play_config["COUGAR"];
        instance.default_trs = play_config["TRS"];
        instance.default_panther = play_config["PANTHER"];
        instance.default_uncia = play_config["UNCIA"];

        instance.active_steering_1p = false;
        instance.active_steering_2p = false;
        instance.steering_assist_type_1p = 1;
        instance.steering_assist_type_2p = 1;
        instance.FFB_assist_1p = false;
        instance.FFB_assist_2p = false;
        instance.FFB_level_1p = 5;
        instance.FFB_level_2p = 5;
        instance.menu_bgm_volume = 100;
        instance.menu_se_volume = 100;
        instance.race_bgm_volume = 90;
        instance.race_se_volume = 90;
        instance.replay_bgm_volume = 90;
        instance.replay_se_volume = 90;
        instance.user_bgm_volume = 90;
        instance.slide_bgm_volume = 100;
        instance.menu_bgm = 1;
        instance.menu_se = 1;
        instance.race_bgm = 1;
        instance.race_se = 1;
        instance.replay_bgm = 1;
        instance.replay_se = 1;
        instance.bgm_upmix_enable = 1;
        instance.speaker_layout = 0;
        instance.speaker_bits = 0;
        instance.speaker_angles[0] = -30;
        instance.speaker_angles[1] = 30;
        instance.speaker_angles[2] = 0;
        instance.speaker_angles[3] = -110;
        instance.speaker_angles[4] = 110;
        instance.speaker_angles[5] = -150;
        instance.speaker_angles[6] = 150;
        instance.speaker_angles[7] = -180;
        instance.sound_dynamic_range = 0;
        instance.loudness_correct = 0;

        for (var i = 0; i < 8; i++)
        {
            instance.sysbgm_use[i] = 0;
            instance.sysbgm_valid[i] = 0;
        }

        instance.screen_brightness = 50;
        instance.screen_sharpness = 0;
        instance.display_margin_sd = 10;
        instance.display_margin_sd_adjust_done = false;
        instance.display_margin_hd = 10;
        instance.display_margin_hd_adjust_done = false;
        instance.gt_hifi = false;
        instance.temporal_aa = 1;
        instance.extra_wide = 0;
        instance.image_quality = 0;
        instance.photo_avatar_visible = false;
        instance.slideshow_style = 0;
        instance.slideshow_interval = 5f;
        instance.slideshow_transition = 1f;
        instance.slideshow_imagetype = 0;
        instance.slideshow_bgm = 1;
        instance.slideshow_repeat = 0;
        instance.slideshow_shuffle = 0;

        instance.stop_install = false;
        instance.server_special_value = "";
        instance.asset_download_on_boot = true;
        instance.fixed_private_room = "";
        instance.is_academy_final = false;
        instance.academy_final_event_id = 0;
        instance.academy_final_is_host = false;
        instance.academy_final_is_entry = false;
        instance.academy_final_course_code = gtengine::MSpecDB::NO_CODE64;
        instance.academy_final_car_code = gtengine::MSpecDB::NO_CODE64;
        instance.academy_final_car_color = 0;
        instance.academy_final_car_grid = 0;
        instance.bot_on = false;
        instance.bot_host = false;
        instance.bot_name = "";
        instance.bot_type = 0;
        instance.bot_group = "";
        instance.bot_room = "";
        instance.bot_course = gtengine::MSpecDB::NO_CODE64;
        instance.force_nickname = "";
        
        for (var i = 0; i < 3; i++)
        {
            instance.bandwidth_up[i] = -1;
            instance.bandwidth_down[i] = -1;
        }

        instance.lounge_demo = false;
        instance.lounge_change_view = false;
        instance.lounge_chat_disabled = false;
        instance.lounge_keyboard_switcher = false;
        instance.lounge_split_screen = false;
        instance.lounge_auto_replay_save = false;
        instance.open_match_course = gtengine::MSpecDB::NO_CODE64;
        instance.open_match_comment = "";
        instance.open_match_only_garage_car = false;
        instance.open_match_room_max = 12;
        instance.open_match_racer_max = 12;
        instance.open_match_voice_chat = false;
        instance.open_match_voice_quality = gtengine::VoiceQuality::NORMAL;
        instance.open_match_trackday_mode = gtengine::TrackDayMode::RACE;
        instance.open_match_auto_grant_ownership = true;
        instance.open_match_room_policy = gtengine::RoomPolicy::ENJOY_RACE;
        instance.pace_force_open_agreement = false;
        instance.pace_on = true;
        instance.pace_download_from_server_only = true;
        instance.pace_debug = false;

        var __256_kbps = 256 * 1024;
        var __bps = __256_kbps / 8;
        instance.pace_upload_rate_max_bps = __bps;
        instance.pace_download_rate_max_bps = -1;

        instance.monitor_host = false;
        instance.monitor_client = false;
        instance.monitor_host_ip = "";
        instance.monitor_follow_host = false;
        instance.monitor_preset = 0;
        instance.monitor_layout = 0;
        instance.monitor_layout_x = 1;
        instance.monitor_layout_y = 1;
        instance.monitor_index = 0;
        instance.monitor_round_xy = 0;
        instance.monitor_round_angle = 0f;
        instance.monitor_view_angle_xy = 1;
        instance.monitor_view_angle = 52f;
        instance.monitor_view_angle_scale = 1f;
        instance.monitor_aspect_ratio_x = 16;
        instance.monitor_aspect_ratio_y = 9;
        instance.monitor_aspect_ratio_enable = false;
        instance.monitor_rotate[0] = 0f;
        instance.monitor_rotate[1] = 0f;
        instance.monitor_rotate[2] = 0f;
        instance.monitor_translate[0] = 0f;
        instance.monitor_translate[1] = 0f;
        instance.monitor_translate[2] = 0f;
        instance.monitor_height = 0f;
        instance.monitor_view_offset_x = 0.03f;
        instance.monitor_convergence = 0f;
        instance.monitor_frame_delay = 0f;
        instance.monitor_frame_delay_enable = false;
        instance.monitor_border[0] = 0f;
        instance.monitor_border[1] = 0f;
        instance.monitor_pixel_jitter_enable = false;
        instance.monitor_flip_timing = 0.97f;
        instance.monitor_flip_timing_enable = false;
        instance.monitor_race_display_enable = 1;
        instance.monitor_race_display_mode = 1;
        instance.monitor_use_parallax_view = false;
        instance.monitor_parallax_change_mode = 7;
        instance.monitor_ui_depth = 0f;
        instance.monitor_auto_boot = 0;

        instance.pseye_face_threshold = 4.0;
        instance.pseye_face_angle =2;
        instance.pseye_face_position = 2;
        instance.pseye_max_face_size = 120;
        instance.pseye_min_face_size = 80;
        instance.pseye_camera_exposure = 0.0;
        instance.pseye_camera_gain = 0.0;

        instance.simulview_2p_battle = 0;

        instance.visible_demo_carshow = true;
        instance.visible_demo_opening = true;
        instance.visible_demo_museum = true;
        instance.visible_demo_race = true;
        instance.visible_demo_replay = true;
        instance.visible_icon_arcade = true;
        instance.visible_icon_gtmode = true;
        instance.visible_icon_news = true;
        instance.visible_icon_gttv = true;
        instance.visible_icon_online = true;
        instance.visible_icon_ranking = true;
        instance.visible_icon_event = true;
        instance.visible_icon_dealer = true;
        instance.visible_icon_replay = true;
        instance.visible_icon_option = true;
        instance.visible_icon_manual = true;
        instance.visible_icon_save = true;
        instance.visible_icon_coursemaker = true;
        instance.visible_icon_dlc = true;
        instance.visible_icon_lounge = false;
        instance.visible_icon_onemake = true;
        instance.visible_icon_timetrial = true;
        instance.visible_icon_singlerace = true;
        instance.visible_icon_drifttrial = true;
        instance.visible_icon_split = true;
        instance.visible_icon_usercustom = true;

        instance.demo_version_code = "";
        instance.academy_mode = false;
        instance.rtext_debug = false;
    }

    function DeclareControllers()
    {
        var controller = gtengine::MController();

#define declare_play_normal(controller, device, port_max, button_channel, analog_channel) \
    for (var port = 0; port < port_max; port++) \
    { \
       if (button_channel != nil) \
           controller.declare(main::gtengine::InputMode::PLAY_NORMAL, device, port, "button", main::pdistd::SuperPortButtonBit[button_channel]); \
       if (analog_channel != nil) \
           controller.declare(main::gtengine::InputMode::PLAY_NORMAL, device, port, "analog", main::pdistd::SuperPortAnalogChannel[analog_channel]); \
    }

        declare_play_normal(controller, "SIXAXIS", 2, "UP", "PRESS_UP");
        declare_play_normal(controller, "SIXAXIS", 2, "DOWN", "PRESS_DOWN");
        declare_play_normal(controller, "SIXAXIS", 2, "LEFT", "PRESS_LEFT");
        declare_play_normal(controller, "SIXAXIS", 2, "RIGHT", "PRESS_RIGHT");
        declare_play_normal(controller, "SIXAXIS", 2, "CIRCLE", "PRESS_CIRCLE");
        declare_play_normal(controller, "SIXAXIS", 2, "CROSS", "PRESS_CROSS");
        declare_play_normal(controller, "SIXAXIS", 2, "TRIANGLE", "PRESS_TRIANGLE");
        declare_play_normal(controller, "SIXAXIS", 2, "SQUARE", "PRESS_SQUARE");
        declare_play_normal(controller, "SIXAXIS", 2, "L1", "PRESS_L1");
        declare_play_normal(controller, "SIXAXIS", 2, "R1", "PRESS_R1");
        declare_play_normal(controller, "SIXAXIS", 2, "L2", "PRESS_L2");
        declare_play_normal(controller, "SIXAXIS", 2, "R2", "PRESS_R2");
        declare_play_normal(controller, "SIXAXIS", 2, nil, "STICK_BY1F");
        declare_play_normal(controller, "SIXAXIS", 2, nil, "STICK_BY1L");
        declare_play_normal(controller, "SIXAXIS", 2, nil, "STICK_BX1");
        declare_play_normal(controller, "SIXAXIS", 2, nil, "STICK_BX1F");
        declare_play_normal(controller, "SIXAXIS", 2, nil, "STICK_BX1L");
        declare_play_normal(controller, "SIXAXIS", 2, nil, "STICK_BY2F");
        declare_play_normal(controller, "SIXAXIS", 2, nil, "STICK_BY2L");
        declare_play_normal(controller, "SIXAXIS", 2, nil, "STICK_BX2");
        declare_play_normal(controller, "SIXAXIS", 2, nil, "STICK_BX2F");
        declare_play_normal(controller, "SIXAXIS", 2, nil, "STICK_BX2L");
        declare_play_normal(controller, "SIXAXIS", 2, "L3", nil);
        declare_play_normal(controller, "SIXAXIS", 2, "R3", nil);
        declare_play_normal(controller, "SIXAXIS", 2, "START", nil);
        declare_play_normal(controller, "SIXAXIS", 2, "SELECT", nil);
        declare_play_normal(controller, "SIXAXIS", 2, "UP", nil);
        declare_play_normal(controller, "SIXAXIS", 2, "DOWN", nil);
        declare_play_normal(controller, "SIXAXIS", 2, "LEFT", nil);
        declare_play_normal(controller, "SIXAXIS", 2, "RIGHT", nil);


        declare_play_normal(controller, "COUGAR", 2, "A", nil);
        declare_play_normal(controller, "COUGAR", 2, "B", nil);
        declare_play_normal(controller, "COUGAR", 2, "X", nil);
        declare_play_normal(controller, "COUGAR", 2, "Y", nil);
        declare_play_normal(controller, "COUGAR", 2, "R", nil);
        declare_play_normal(controller, "COUGAR", 2, "L", nil);


        declare_play_normal(controller, "JAGUAR", 2, "UP", nil);
        declare_play_normal(controller, "JAGUAR", 2, "DOWN", nil);
        declare_play_normal(controller, "JAGUAR", 2, "LEFT", nil);
        declare_play_normal(controller, "JAGUAR", 2, "RIGHT", nil);
        declare_play_normal(controller, "JAGUAR", 2, "TRIANGLE", nil);
        declare_play_normal(controller, "JAGUAR", 2, "CROSS", nil);
        declare_play_normal(controller, "JAGUAR", 2, "SQUARE", nil);
        declare_play_normal(controller, "JAGUAR", 2, "CIRCLE", nil);
        declare_play_normal(controller, "JAGUAR", 2, "R", nil);
        declare_play_normal(controller, "JAGUAR", 2, "R1", nil);
        declare_play_normal(controller, "JAGUAR", 2, "R2", nil);
        declare_play_normal(controller, "JAGUAR", 2, "L", nil);
        declare_play_normal(controller, "JAGUAR", 2, "L1", nil);
        declare_play_normal(controller, "JAGUAR", 2, "L2", nil);
        declare_play_normal(controller, "JAGUAR", 2, "START", nil);
        declare_play_normal(controller, "JAGUAR", 2, "SELECT", nil);


        declare_play_normal(controller, "TIGAR", 2, "UP", nil);
        declare_play_normal(controller, "TIGAR", 2, "DOWN", nil);
        declare_play_normal(controller, "TIGAR", 2, "LEFT", nil);
        declare_play_normal(controller, "TIGAR", 2, "RIGHT", nil);
        declare_play_normal(controller, "TIGAR", 2, "TRIANGLE", nil);
        declare_play_normal(controller, "TIGAR", 2, "CROSS", nil);
        declare_play_normal(controller, "TIGAR", 2, "SQUARE", nil);
        declare_play_normal(controller, "TIGAR", 2, "CIRCLE", nil);
        declare_play_normal(controller, "TIGAR", 2, "R1", nil);
        declare_play_normal(controller, "TIGAR", 2, "R2", nil);
        declare_play_normal(controller, "TIGAR", 2, "R3", nil);
        declare_play_normal(controller, "TIGAR", 2, "L1", nil);
        declare_play_normal(controller, "TIGAR", 2, "L2", nil);
        declare_play_normal(controller, "TIGAR", 2, "L3", nil);
        declare_play_normal(controller, "TIGAR", 2, "START", nil);
        declare_play_normal(controller, "TIGAR", 2, "SELECT", nil);


        declare_play_normal(controller, "CHEETAH", 2, "UP", nil);
        declare_play_normal(controller, "CHEETAH", 2, "DOWN", nil);
        declare_play_normal(controller, "CHEETAH", 2, "LEFT", nil);
        declare_play_normal(controller, "CHEETAH", 2, "RIGHT", nil);
        declare_play_normal(controller, "CHEETAH", 2, "TRIANGLE", nil);
        declare_play_normal(controller, "CHEETAH", 2, "CROSS", nil);
        declare_play_normal(controller, "CHEETAH", 2, "SQUARE", nil);
        declare_play_normal(controller, "CHEETAH", 2, "CIRCLE", nil);
        declare_play_normal(controller, "CHEETAH", 2, "R1", nil);
        declare_play_normal(controller, "CHEETAH", 2, "R2", nil);
        declare_play_normal(controller, "CHEETAH", 2, "R3", nil);
        declare_play_normal(controller, "CHEETAH", 2, "L1", nil);
        declare_play_normal(controller, "CHEETAH", 2, "L2", nil);
        declare_play_normal(controller, "CHEETAH", 2, "L3", nil);
        declare_play_normal(controller, "CHEETAH", 2, "START", nil);
        declare_play_normal(controller, "CHEETAH", 2, "SELECT", nil);
        declare_play_normal(controller, "CHEETAH", 2, "SHIFT_DOWN", nil);
        declare_play_normal(controller, "CHEETAH", 2, "SHIFT_UP", nil);


        declare_play_normal(controller, "PANTHER", 2, "UP", nil);
        declare_play_normal(controller, "PANTHER", 2, "DOWN", nil);
        declare_play_normal(controller, "PANTHER", 2, "LEFT", nil);
        declare_play_normal(controller, "PANTHER", 2, "RIGHT", nil);
        declare_play_normal(controller, "PANTHER", 2, "TRIANGLE", nil);
        declare_play_normal(controller, "PANTHER", 2, "CROSS", nil);
        declare_play_normal(controller, "PANTHER", 2, "SQUARE", nil);
        declare_play_normal(controller, "PANTHER", 2, "CIRCLE", nil);
        declare_play_normal(controller, "PANTHER", 2, "R1", nil);
        declare_play_normal(controller, "PANTHER", 2, "R2", nil);
        declare_play_normal(controller, "PANTHER", 2, "R3", nil);
        declare_play_normal(controller, "PANTHER", 2, "L1", nil);
        declare_play_normal(controller, "PANTHER", 2, "L2", nil);
        declare_play_normal(controller, "PANTHER", 2, "L3", nil);
        declare_play_normal(controller, "PANTHER", 2, "START", nil);
        declare_play_normal(controller, "PANTHER", 2, "SELECT", nil);
        declare_play_normal(controller, "PANTHER", 2, "SHIFT_DOWN", nil);
        declare_play_normal(controller, "PANTHER", 2, "SHIFT_UP", nil);


        declare_play_normal(controller, "LEOPARD", 2, "UP", nil);
        declare_play_normal(controller, "LEOPARD", 2, "DOWN", nil);
        declare_play_normal(controller, "LEOPARD", 2, "LEFT", nil);
        declare_play_normal(controller, "LEOPARD", 2, "RIGHT", nil);
        declare_play_normal(controller, "LEOPARD", 2, "TRIANGLE", nil);
        declare_play_normal(controller, "LEOPARD", 2, "CROSS", nil);
        declare_play_normal(controller, "LEOPARD", 2, "SQUARE", nil);
        declare_play_normal(controller, "LEOPARD", 2, "CIRCLE", nil);
        declare_play_normal(controller, "LEOPARD", 2, "R1", nil);
        declare_play_normal(controller, "LEOPARD", 2, "R2", nil);
        declare_play_normal(controller, "LEOPARD", 2, "R3", nil);
        declare_play_normal(controller, "LEOPARD", 2, "L1", nil);
        declare_play_normal(controller, "LEOPARD", 2, "L2", nil);
        declare_play_normal(controller, "LEOPARD", 2, "L3", nil);
        declare_play_normal(controller, "LEOPARD", 2, "START", nil);
        declare_play_normal(controller, "LEOPARD", 2, "SELECT", nil);
        declare_play_normal(controller, "LEOPARD", 2, "SHIFT_DOWN", nil);
        declare_play_normal(controller, "LEOPARD", 2, "SHIFT_UP", nil);
        declare_play_normal(controller, "LEOPARD", 2, "PLUS", nil);
        declare_play_normal(controller, "LEOPARD", 2, "MINUS", nil);
        declare_play_normal(controller, "LEOPARD", 2, "DIAL_OPEN", nil);
        declare_play_normal(controller, "LEOPARD", 2, nil, "RELATIVE_DIAL_B");


        declare_play_normal(controller, "TRS", 2, "UP", nil);
        declare_play_normal(controller, "TRS", 2, "DOWN", nil);
        declare_play_normal(controller, "TRS", 2, "LEFT", nil);
        declare_play_normal(controller, "TRS", 2, "RIGHT", nil);
        declare_play_normal(controller, "TRS", 2, "TRIANGLE", nil);
        declare_play_normal(controller, "TRS", 2, "CROSS", nil);
        declare_play_normal(controller, "TRS", 2, "SQUARE", nil);
        declare_play_normal(controller, "TRS", 2, "CIRCLE", nil);
        declare_play_normal(controller, "TRS", 2, "R1", nil);
        declare_play_normal(controller, "TRS", 2, "R2", nil);
        declare_play_normal(controller, "TRS", 2, "R3", nil);
        declare_play_normal(controller, "TRS", 2, "L1", nil);
        declare_play_normal(controller, "TRS", 2, "L2", nil);
        declare_play_normal(controller, "TRS", 2, "L3", nil);
        declare_play_normal(controller, "TRS", 2, "START", nil);
        declare_play_normal(controller, "TRS", 2, "SELECT", nil);
        declare_play_normal(controller, "TRS", 2, "PADDLE_LEFT", nil);
        declare_play_normal(controller, "TRS", 2, "PADDLE_RIGHT", nil);


        declare_play_normal(controller, "UNCIA", 2, "UP", nil);
        declare_play_normal(controller, "UNCIA", 2, "DOWN", nil);
        declare_play_normal(controller, "UNCIA", 2, "LEFT", nil);
        declare_play_normal(controller, "UNCIA", 2, "RIGHT", nil);
        declare_play_normal(controller, "UNCIA", 2, "TRIANGLE", nil);
        declare_play_normal(controller, "UNCIA", 2, "CROSS", nil);
        declare_play_normal(controller, "UNCIA", 2, "SQUARE", nil);
        declare_play_normal(controller, "UNCIA", 2, "CIRCLE", nil);
        declare_play_normal(controller, "UNCIA", 2, "R1", nil);
        declare_play_normal(controller, "UNCIA", 2, "R2", nil);
        declare_play_normal(controller, "UNCIA", 2, "R3", nil);
        declare_play_normal(controller, "UNCIA", 2, "R4", nil);
        declare_play_normal(controller, "UNCIA", 2, "R5", nil);
        declare_play_normal(controller, "UNCIA", 2, "L1", nil);
        declare_play_normal(controller, "UNCIA", 2, "L2", nil);
        declare_play_normal(controller, "UNCIA", 2, "L3", nil);
        declare_play_normal(controller, "UNCIA", 2, "L4", nil);
        declare_play_normal(controller, "UNCIA", 2, "L5", nil);
        declare_play_normal(controller, "UNCIA", 2, "START", nil);
        declare_play_normal(controller, "UNCIA", 2, "SELECT", nil);
        declare_play_normal(controller, "UNCIA", 2, "SHIFT_DOWN", nil);
        declare_play_normal(controller, "UNCIA", 2, "SHIFT_UP", nil);

    }

    function DefineMethod()
    {
        module Impl
        {
            import __toplevel__::main;

            method apply()
            {   
                if (self.extra_language != pdistd::Language::SYSTEM)
                    pdistd::SetLanguage(self.extra_language);
                else
                    pdiext::SetStaticLanguage();

                main::pdiext::MUnit::SetUnitSystemByLanguage(pdistd::MLocale::getLanguage());

                main::pdiext::MUnit::SetUnitOfVelocity(self.unit_velocity);
                main::gtengine::MController::setVibration(0, self.vibration_1p);
                main::gtengine::MController::setVibration(1, self.vibration_1p); // BUG: I think this is supposed to be vibration_2p?
                main::gtengine::MController::setFFBassist(0, self.FFB_assist_1p);
                main::gtengine::MController::setFFBassist(1, self.FFB_assist_2p);
                main::gtengine::MController::setFFBlevel(0, self.FFB_level_1p);
                main::gtengine::MController::setFFBlevel(1, self.FFB_level_2p);

                main::ORG.replay_mode = self.replay_mode;
                main::ORG.full_quality_replay = self.full_quality_replay;

                SoundUtil::SetDynamicRangeOption(self.sound_dynamic_range);
                SoundUtil::SetSoundEnableOption(self.menu_bgm, self.menu_se, self.race_bgm,
                    self.race_se, self.replay_bgm, self.replay_se);
                SoundUtil::SetSoundVolumeOption(self.menu_bgm_volume, self.menu_se_volume, self.race_bgm_volume, self.race_se_volume,
                    self.replay_bgm_volume, self.replay_se_volume, self.user_bgm_volume);
                SoundUtil::SetBGMUpmixOption(self.bgm_upmix_enable);
                SoundUtil::ApplySoundVolumeOption();
                SoundUtil::ApplySpeakerLayoutOption(self.speaker_bits);

                var sysbgm_any = false;
                for (var i = 0; i < 3; i++)
                {
                    var use = self.sysbgm_use[i];
                    var valid = self.sysbgm_valid[i];
                    sysbgm_any |= use && valid;
                }

                if (sysbgm_any)
                    PDINetwork.unlockTrophyAsync(gtengine::TrophyType::USE_CUSTOM_BGM);

                var exposure = (self.screen_brightness.toFloat() - 50f) / 50f;
                main::pdiext::MSystemConfiguration::SetMasterRenderExposure(exposure);
                
                var sdtv = main::pdiext::MSystemConfiguration::isSDTV();
                var scale = sdtv ? self.display_margin_sd : self.display_margin_hd;
                var margin = scale.toFloat() / 100f;
                main::pdiext::MSystemConfiguration::SetDisplayMargin(margin);
                
                main::ORG.gt_hifi = self.gt_hifi;
                main::ORG.extra_wide = self.extra_wide;
                
                var quality_define = [
                    [0, 1], 
                    [0, 0], 
                    [1, 1]
                ];

                main::pdiext::MSystemConfiguration::SetScreenSharpness(quality_define[self.image_quality][0]);
                main::pdiext::MSystemConfiguration::SetTemporalAntialias(quality_define[self.image_quality][1] && self.temporal_aa);

                if (self.stop_install)
                    pdistd::SetFileSystemOptionInt64("/", "PreCopyFileSizeLimit", 0);
                else
                    pdistd::SetFileSystemOptionInt64("/", "PreCopyFileSizeLimit", -1);

                main::ORG.monitor_host = self.monitor_host;
                main::ORG.monitor_host_ip = self.monitor_host_ip;
                main::ORG.monitor_index = self.monitor_index;
                main::ORG.monitor_round_y = self.monitor_round_xy != 0;
                main::ORG.monitor_round_angle = self.monitor_round_angle;
                main::ORG.monitor_view_angle_y = self.monitor_view_angle_xy != 0;
                main::ORG.monitor_view_angle = self.monitor_view_angle;
                main::ORG.monitor_aspect_ratio_enable = self.monitor_aspect_ratio_enable;
                main::ORG.monitor_aspect_ratio = self.monitor_aspect_ratio_x.toFloat() / self.monitor_aspect_ratio_y.toFloat();
                main::ORG.monitor_view_offset_x = self.monitor_view_offset_x;
                main::ORG.monitor_convergence = self.monitor_convergence;
                main::ORG.monitor_frame_delay = self.monitor_frame_delay;
                main::ORG.monitor_frame_delay_enable = self.monitor_frame_delay_enable;
                main::ORG.monitor_border = [self.monitor_border[0], self.monitor_border[1]];
                main::ORG.monitor_pixel_jitter_enable = self.monitor_pixel_jitter_enable;
                main::ORG.monitor_race_display_enable = self.monitor_race_display_enable;
                main::ORG.monitor_race_display_mode = self.monitor_race_display_mode;
                main::ORG.monitor_follow_host = self.monitor_follow_host;

                main::ORG.setUseParallaxView(self.monitor_use_parallax_view.toInt());
                main::ORG.setParallaxChangeMode(self.monitor_parallax_change_mode.toInt());
                ORG.setMonitorLayout(self.monitor_layout_x, self.monitor_layout_y);

                ORG.monitor_view_angle_scale = self.monitor_view_angle_scale;
                ORG.onGameOptionApply();

                pdiext::MSystemConfiguration::SetFlipTiming(self.monitor_flip_timing_enable ? self.monitor_flip_timing : 0f);

                main::FaceDetector.threshold = self.pseye_face_threshold;
                main::FaceDetector.angle_sensitive = self.pseye_face_angle;
                main::FaceDetector.position_sensitive = self.pseye_face_position;
                main::FaceDetector.max_face_size = self.pseye_max_face_size;
                main::FaceDetector.min_face_size = self.pseye_min_face_size;
                main::FaceDetector.camera_gain = self.pseye_camera_gain;
                main::FaceDetector.camera_exposure = self.pseye_camera_exposure;
                
                main::pdistd::MRText::SetDebug(self.rtext_debug.toBool());
            }

            method hasFavoriteCar()
            {
                for (var i = 0; i < 80; i++)
                {
                    if (self.favorite_cars[i] != main::gtengine::MSpecDB::NO_CODE64)
                        return true;
                }

                return false;
            }

            method getFavoriteCars()
            {
                var result = [];
                for (var i = 0; i < 80; i++)
                {
                    if (self.favorite_cars[i] != main::gtengine::MSpecDB::NO_CODE64)
                    {
                        result.push(self.favorite_cars[i]);
                    }
                }
                
                return result;
            }

            method hasFavoriteDemoCar()
            {
                for (var i = 0; i < 80; i++)
                {
                    if (self.favorite_demo_cars[i] != main::gtengine::MSpecDB::NO_CODE64)
                        return true;
                }

                return false;
            }

            method getFavoriteDemoCars()
            {
                var result = [];
                for (var i = 0; i < 80; i++)
                {
                    if (self.favorite_demo_cars[i] != main::gtengine::MSpecDB::NO_CODE64)
                    {
                        result.push(self.favorite_demo_cars[i]);
                    }
                }
                
                return result;
            }

            method hasFavoriteEnemy()
            {
                for (var i = 0; i < 80; i++)
                {
                    if (self.favorite_enemies[i] != main::gtengine::MSpecDB::NO_CODE64)
                        return true;
                }

                return false;
            }

            method getFavoriteEnemies()
            {
                var result = [];
                for (var i = 0; i < 80; i++)
                {
                    if (self.favorite_enemies[i] != main::gtengine::MSpecDB::NO_CODE64)
                    {
                        result.push(self.favorite_enemies[i]);
                    }
                }
                
                return result;
            }

            method hasFavoriteCourse()
            {
                for (var i = 0; i < 20; i++)
                {
                    if (self.favorite_courses[i] != main::gtengine::MSpecDB::NO_CODE64)
                        return true;
                }

                return false;
            }

            method getFavoriteCourses()
            {
                var result = [];
                for (var i = 0; i < 20; i++)
                {
                    if (self.favorite_courses[i] != main::gtengine::MSpecDB::NO_CODE64)
                    {
                        result.push(self.favorite_courses[i]);
                    }
                }
                
                return result;
            }

            method isFavoriteCourse(course)
            {
                for (var i = 0; i < 20; i++)
                {
                    if (self.favorite_courses[i] == course)
                        return true;
                }

                return false;
            }

            method setSystemBGMSetting(type, enable, sysbgm_context)
            {
                self.sysbgm_use[type] = enable;
                if (sysbgm_context != nil)
                {
                    self.sysbgm_context[type] = sysbgm_context;
                    self.sysbgm_valid[type] = true;
                }
            }

            method getSystemBGMSetting(type)
            {
                return [self.sysbgm_use[type] && self.sysbgm_valid[type], self.sysbgm_context[type], self.sysbgm_valid[type]];
            }

            method addBandwidthRecord(args)
            {
                if (args == nil)
                    return;

                |var up, var down| = args;
                if (up > 0 && down > 0)
                {
                    if (up == self.bandwidth_up[0] && down == self.bandwidth_down[0])
                        return;

                    for (var i = 3 - 1; i > 0; i--)
                    {
                        self.bandwidth_up[i] = self.bandwidth_up[i - 1];
                        self.bandwidth_down[i] = self.bandwidth_down[i - 1];
                    }

                    self.bandwidth_up[0] = up;
                    self.bandwidth_down[0] = down;
                }
            }

            method getAverageBandwidth()
            {
                var up = 0;
                var down = 0;
                var count = 0;

                for (var i = 0; i < 3; i++)
                {
                    if (self.bandwidth_up[i] > 0)
                    {
                        up += self.bandwidth_up[i];
                        down += self.bandwidth_down[i];
                        ++count;
                    }
                }

                if (count > 0)
                {
                    up /= count;
                    down /= count;
                }    
                
                return [up, down];
            }

            method hasAmpleBandwidthData()
            {
                for (var i = 0; i < 3; i++)
                {
                    if (self.bandwidth_up[i] < 1)
                        return false;
                }

                return true;
            }
        }
    }
}